#!/bin/bash

# Exit immediately if a command exits with a non-zero status.
set -e

# --- Configuration Variables ---
# Base directory for experiments, MATLAB scripts, job files, and output files
TABLE_NAME="nmfsl"
BASE_DIR="/home1/jongminm/sparse_kmeans/experiment/30_08_15_2025/${TABLE_NAME}"
# Path to the SQLite database
DB_DIR="/home1/jongminm/sparse_kmeans/sparse_kmeans.db"
# Table name within the SQLite database


# --- MATLAB Simulation Parameters (Shell Variables) ---
# These variables will be passed into the generated MATLAB scripts
MODEL='iso'
CLUSTER_1_RATIO=0.5
SEP=4
 N=200
 
 T=100
delta=0
 
# --- Ensure Base Directory Exists ---
# Create the base directory if it doesn't already exist
mkdir -p "$BASE_DIR"

echo "Starting SLURM job generation..."
echo "Base Directory: $BASE_DIR"
echo "Database Directory: $DB_DIR"
echo "Table Name: $TABLE_NAME"
echo "MATLAB Model: $MODEL"
echo "Cluster 1 Ratio: $CLUSTER_1_RATIO"
echo "Separation: $SEP"
echo "Number of samples (n): $N"

# --- Loop through simulation parameters ---
# Loop for 'rep' (repetition) from 1 to 200
for REP in $(seq 1 100); do
    # Loop for 'p' (number of features/dimensions)

    for P in  1000 2000 3000 4000 5000   ; do

        # Define filenames based on current parameters
        MFILE_NAME="${TABLE_NAME}_${SEP}_p${P}_rep_${REP}" # Name without .m extension
        MFILE="$BASE_DIR/${MFILE_NAME}.m"
        JOBFILE="$BASE_DIR/${MFILE_NAME}.sh"
        OUTFILE="$BASE_DIR/${MFILE_NAME}.out"

        echo "Generating files for p=${P}, rep=${REP}..."

        # === Create MATLAB .m file ===
        # This block writes the MATLAB code into the .m file
        cat > "$MFILE" <<EOF
% MATLAB script generated by SLURM job generator

% Add necessary paths for sparse_kmeans functions
addpath(genpath('/home1/jongminm/sparse_kmeans'));

% --- Database Configuration ---
table_name = '${TABLE_NAME}';
db_dir = '${DB_DIR}';

% --- Simulation Parameters ---
% These values are passed from the shell script
model = '${MODEL}';
cluster_1_ratio = ${CLUSTER_1_RATIO};
sep = ${SEP}; % Separation parameter
n = ${N};     % Number of samples
p = ${P};     % Number of features/dimensions (current loop variable)
rep = ${REP}; % Repetition number (current loop variable)
delta = ${delta};
fprintf('--- Starting MATLAB simulation for p=%d, rep=%d ---\\n', p, rep);

% --- Data Generation ---
generator = data_generator_approximately_sparse_mean(n, p, 10, sep, rep, 0.5)
[data, label_true] = generator.get_data(1, delta);
 

% --- Run sdp_kmeans_bandit_even_simul ---
clusterer = sdp_kmeans_iter_knowncov_SL_NMF(data, 2);
cluster_est=clusterer.fit_predict(${T});
acc = get_bicluster_accuracy(cluster_est, label_true);
table = get_database_subtable(rep, sep, 1:10,  clusterer,  acc);

% --- Insert Results into SQLite Database ---
% Insert the results from the bandit simulation into the specified SQLite table
% The '1:10' is assumed to be a placeholder for a specific range or set of values.
insertTableIntoSQLite(db_dir, table_name, table, rep, sep, 1:10);

fprintf('--- Finished MATLAB simulation for p=%d, rep=%d ---\\n', p, rep);

% Exit MATLAB cleanly after script execution
exit;
EOF

        # === Create SLURM Job Script (.sh file) ===
        # This block writes the SLURM batch script
        cat > "$JOBFILE" <<EOF
#!/bin/bash
#SBATCH --job-name=${TABLE_NAME}_p${P}_rep${REP} # Job name for easier identification in queue
#SBATCH --output="${OUTFILE}"              # Standard output and error log file
#SBATCH --partition=main                   # Specify the partition to use
#SBATCH --nodes=1                          # Request 1 node
#SBATCH --ntasks=1                         # Request 1 task (process)
#SBATCH --cpus-per-task=2                 # Request 8 CPUs per task (for MATLAB's multi-threading)
#SBATCH --mem=2G                           # Request 6 GB of memory
#SBATCH --time=0:59:59                    # Set maximum job run time (HH:MM:SS)

# Echo start time and hostname for logging
echo "Starting job for p=${P}, rep=${REP} on \$(hostname) at \$(date)"

# Load necessary modules
# Ensure these module commands are correct for your cluster environment
module purge                # Unload all currently loaded modules
module load legacy/CentOS7  # Load specific OS environment if required
module load matlab/2022a    # Load the MATLAB module

# Change to the base directory where the MATLAB script is located
# Use '|| { ... }' for robust error handling if directory change fails
cd "$BASE_DIR" || { echo "Error: Could not change to directory $BASE_DIR. Exiting."; exit 1; }

# Run the MATLAB script in batch mode
# The -batch option runs the specified script and then exits MATLAB
matlab -batch "${MFILE_NAME}"

# Echo end time for logging
echo "Finished job for p=${P}, rep=${REP} at \$(date)"
EOF

        # === Submit SLURM Job ===
        # Submit the generated job script to the SLURM scheduler
        echo "Submitting job: $JOBFILE"
        sbatch "$JOBFILE"

        # Pause for 1 second to avoid overwhelming the SLURM scheduler
        sleep 1

    done # End of P loop
done     # End of REP loop

echo "All SLURM jobs have been generated and submitted."
