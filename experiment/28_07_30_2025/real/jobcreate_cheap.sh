#!/bin/bash

# Directories
TABLE_NAME="real"
BASE_DIR="/home1/jongminm/sparse_kmeans/experiment/28_07_30_2025/${TABLE_NAME}"

# Database directory
DB_DIR="/home1/jongminm/sparse_kmeans/sparse_kmeans.db"

 T=20

# Loop through different P values
#for P in 100 200 300 400; do
    for rep in $(seq 2 30   ); do
     # Loop through repetitions

        # Define filenames for .m, .sh, and .out files
        MFILE="$BASE_DIR/${TABLE_NAME}_cheap_rep_${rep}_p${P}.m"
        JOBFILE="$BASE_DIR/${TABLE_NAME}_cheap_rep_${rep}_p${P}.sh"
        OUTFILE="$BASE_DIR/${TABLE_NAME}_cheap_rep_${rep}_p${P}.out"

        # Create base directory if it doesn't exist
        mkdir -p "$BASE_DIR"

        # === Create .m (MATLAB) file ===
        cat > "$MFILE" <<EOF
% MATLAB script generated by bash script
 

 
rep = ${rep};
 % Add sparse_kmeans path
addpath(genpath('/home1/jongminm/sparse_kmeans'));

% Define the file paths
file_x = "leuk_x.txt";
x = readmatrix(file_x);
disp(['Size of x: ' num2str(size(x))])
x = 2.^x;
 
file_y = "leuk_y.txt";
y = readmatrix(file_y);
y= y' +1
disp(['Size of colon_y: ' num2str(size(y))]);
 

% Add sparse_kmeans path
addpath(genpath('/home1/jongminm/sparse_kmeans'));

% Database and table names
table_name = '${TABLE_NAME}';
db_dir = '${DB_DIR}';
 n_subsample = 45
 
gen = data_generator_subsample(x, y);
 
    [x_new, y_new] = gen.get_data(n_subsample, rep);
 


    p=size(x_new,2);



 
    %ifpca
    rng(rep)
    sol_ifpca = ifpca(x_new, 2);
    acc_ifpca = get_bicluster_accuracy(sol_ifpca, y_new);
    table_ifpca = get_database_subtable2(rep, 0, 1:10,  n_subsample,p,  acc_ifpca, "ifpca");    
    insertTableIntoSQLite(db_dir, table_name, table_ifpca, rep, 0, 1:10);
    
  

    %plain sdp
 rng(rep)
    sol_sdp =  sdp_kmeans(x_new, 2);
   acc_sdp = get_bicluster_accuracy(sol_sdp, y_new);
    table_sdp = get_database_subtable2(rep, 0, 1:10,  n_subsample,p,  acc_sdp, "sdp"); 
insertTableIntoSQLite(db_dir, table_name, table_sdp, rep, 0, 1:10);
 
        %our method, isotropic
         rng(rep)
  clusterer = sdp_kmeans_iter_knowncov(x_new, 2);
    sol_itersdp=clusterer.fit_predict(${T});
    acc_itersdp = get_bicluster_accuracy(sol_itersdp, y_new);
    table_itersdp = get_database_subtable2(rep, 0, 1:10,  n_subsample,p,  acc_itersdp, "itersdp");    
    insertTableIntoSQLite(db_dir, table_name, table_itersdp, rep, 0, 1:10);
EOF

        # === Create SLURM job script ===
        cat > "$JOBFILE" <<EOF
#!/bin/bash
#SBATCH --output="${OUTFILE}"
#SBATCH --partition=main
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=2
#SBATCH --mem=2G
 
# Echo job start time and host
echo "Starting job for rep=${rep} on \$(hostname) at \$(date)"

# Load necessary modules
module purge
module load legacy/CentOS7
module load matlab/2022a

# Change to base directory
cd "$BASE_DIR"

# Run MATLAB script in batch mode
matlab -batch ${TABLE_NAME}_cheap_rep_${rep}_p${P}

# Echo job finish time
echo "Finished job for rep=${rep} at \$(date)"
EOF

        # === Submit job to SLURM ===
        echo "Submitting job: $JOBFILE"
        sbatch "$JOBFILE"
        # Small delay to avoid overwhelming the scheduler
        sleep 1
 done
