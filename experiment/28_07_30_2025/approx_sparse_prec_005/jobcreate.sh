#!/bin/bash

# Directories
TABLE_NAME="approx_sparse_prec_005"
BASE_DIR="/home1/jongminm/sparse_kmeans/experiment/28_07_30_2025/${TABLE_NAME}"

# Database directory
DB_DIR="/home1/jongminm/sparse_kmeans/sparse_kmeans.db"

# Define delta parameter
delta=0.05

# Loop through different P values
#for P in 100 200 300 400; do
    for rep in $(seq 51 100); do
for P in   400 300 200 100; do
    # Loop through repetitions

        # Define filenames for .m, .sh, and .out files
        MFILE="$BASE_DIR/${TABLE_NAME}_rep_${rep}_p${P}.m"
        JOBFILE="$BASE_DIR/${TABLE_NAME}_rep_${rep}_p${P}.sh"
        OUTFILE="$BASE_DIR/${TABLE_NAME}_rep_${rep}_p${P}.out"

        # Create base directory if it doesn't exist
        mkdir -p "$BASE_DIR"

        # === Create .m (MATLAB) file ===
        cat > "$MFILE" <<EOF
% MATLAB script generated by bash script

% Configure local parallel cluster
pc = parallel.cluster.Local;
job_folder = fullfile('/home1/jongminm/.matlab/local_cluster_jobs/R2022a', getenv('SLURM_JOB_ID'));
if ~exist(job_folder, 'dir')
    mkdir(job_folder);
end
set(pc, 'JobStorageLocation', job_folder);

% Determine number of cores for parallel pool
ncores = str2num(getenv('SLURM_CPUS_PER_TASK')) - 1;
pool = parpool(pc, ncores);

% Define simulation parameters
s = 10;
p = ${P};
rep = ${rep};
sep = 4;
delta = ${delta};
n = 500;

% Add sparse_kmeans path
addpath(genpath('/home1/jongminm/sparse_kmeans'));

% Database and table names
table_name = '${TABLE_NAME}';
db_dir = '${DB_DIR}';

% Data generation
cluster_1_ratio = 0.5;
% Note: Semicolon added to suppress output
generator = data_generator_approximately_sparse_precision(n, p, s, sep, rep, 0.5);
[data, label_true] = generator.get_data(delta);

% Run ISEE_kmeans_clean_simul
model = 'chain45'
ISEE_kmeans_clean_simul(data, 2, 100, true, 10, 5, 0.01, db_dir, table_name, rep, model, sep, label_true);

% Delete parallel pool
delete(pool);
EOF

        # === Create SLURM job script ===
        cat > "$JOBFILE" <<EOF
#!/bin/bash
#SBATCH --output="${OUTFILE}"
#SBATCH --partition=main
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=4
#SBATCH --mem=8G
#SBATCH --time=3:59:59

# Echo job start time and host
echo "Starting job for rep=${rep} on \$(hostname) at \$(date)"

# Load necessary modules
module purge
module load legacy/CentOS7
module load matlab/2022a

# Change to base directory
cd "$BASE_DIR"

# Run MATLAB script in batch mode
matlab -batch ${TABLE_NAME}_rep_${rep}_p${P}

# Echo job finish time
echo "Finished job for rep=${rep} at \$(date)"
EOF

        # === Submit job to SLURM ===
        echo "Submitting job: $JOBFILE"
        sbatch "$JOBFILE"
        # Small delay to avoid overwhelming the scheduler
        sleep 1
    done
done
