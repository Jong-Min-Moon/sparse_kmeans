% MATLAB script generated by bash script

% Configure local parallel cluster
pc = parallel.cluster.Local;
job_folder = fullfile('/home1/jongminm/.matlab/local_cluster_jobs/R2022a', getenv('SLURM_JOB_ID'));
if ~exist(job_folder, 'dir')
    mkdir(job_folder);
end
set(pc, 'JobStorageLocation', job_folder);

% Determine number of cores for parallel pool
ncores = str2num(getenv('SLURM_CPUS_PER_TASK')) - 1;
pool = parpool(pc, ncores);

% Define simulation parameters
s = 10;
p = 200;
rep = 46;
sep = 4;
delta = 0.05;
n = 500;

% Add sparse_kmeans path
addpath(genpath('/home1/jongminm/sparse_kmeans'));

% Database and table names
table_name = 'noniso_cov_diff_005';
db_dir = '/home1/jongminm/sparse_kmeans/sparse_kmeans.db';

% Data generation
cluster_1_ratio = 0.5;
% Note: Semicolon added to suppress output
generator = data_generator_correlated_different_cov(n, p, s, sep, rep, 0.5);
[data, label_true] = generator.get_data(1, delta);

% Run ISEE_kmeans_clean_simul
model = 'chain45'
ISEE_kmeans_clean_simul(data, 2, 100, true, 10, 5, 0.01, db_dir, table_name, rep, model, sep, label_true);

% Delete parallel pool
delete(pool);
